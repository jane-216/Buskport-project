import { db } from './db.js';

/** @typedef {{
 *  id: string;
 *  key?: string;
 *  name: string;
 *  description: string;
 *  points: number;
 *  icon: string;
 *  category: 'Listing'|'Sales'|'Social'|'Onboarding'|'Streak'|string;
 *  secret?: boolean;
 *  metric: string;
 *  threshold: number;
 *  check: (s: Record<string, number>) => true | {progress:number, target:number};
 * }} AchievementRule */

/** ê³µí†µ check ìƒì„±ê¸° */
function makeCheck(metric, threshold) {
  return (s) => (Number(s?.[metric] ?? 0) >= threshold)
    ? true
    : { progress: Number(s?.[metric] ?? 0), target: threshold };
}

/** rule ìƒì„± í—¬í¼ (DRY) */
function makeRule({
  id, name, description, points, icon, category, metric, threshold, secret = false, key,
}) {
  return {
    id,
    key: key ?? id, // idì™€ ë™ì¼í•˜ë©´ key ìƒëµ ê°€ëŠ¥
    name,
    description,
    points,
    icon,
    category,
    secret,
    metric,
    threshold,
    check: makeCheck(metric, threshold),
  };
}

/** ê·œì¹™ ì •ì˜ */
export const RULES = [
  makeRule({
    id: 'five_listings',
    name: 'íŒë§¤ ì¤€ë¹„ (ë“±ë¡)',
    description: 'íŒë§¤ê¸€ì„ ë“±ë¡í–ˆì–´ìš”.',
    points: 15,
    icon: 'ğŸ–ï¸',
    category: 'Listing',
    metric: 'listings',
    threshold: 5,
  }),
  makeRule({
    id: 'first_sale',
    name: 'ì²« íŒë§¤',
    description: 'ì²˜ìŒ ê±°ë˜ë¥¼ ì„±ê³µí–ˆì–´ìš”.',
    points: 25,
    icon: 'ğŸ’¸',
    category: 'Sales',
    metric: 'sales',
    threshold: 1,
  }),
  makeRule({
    id: 'five_sales',
    name: 'ê±°ë˜ ì¥ì¸ (5íšŒ)',
    description: '5íšŒ ê±°ë˜ë¥¼ í–ˆì–´ìš”.',
    points: 50,
    icon: 'ğŸ¥‡',
    category: 'Sales',
    metric: 'sales',
    threshold: 5,
  }),
  makeRule({
    id: 'ten_chats',
    name: 'ì†Œí†µì™• (10íšŒ ì±„íŒ…)',
    description: '10ë²ˆì˜ ì±„íŒ…ì„ ì‹œì‘í–ˆì–´ìš”.',
    points: 15,
    icon: 'ğŸ’¬',
    category: 'Social',
    metric: 'chats',
    threshold: 10,
  }),
  makeRule({
    id: 'profile_complete',
    name: 'í”„ë¡œí•„ 100% ì™„ë£Œ',
    description: 'í”„ë¡œí•„ ì •ë³´ë¥¼ ëª¨ë‘ ì±„ì› ì–´ìš”.',
    points: 10,
    icon: 'ğŸ§‘â€ğŸ’¼',
    category: 'Onboarding',
    metric: 'profile_completed',
    threshold: 1,
  }),
  makeRule({
    id: 'login_streak_3',
    name: '3ì¼ ì—°ì† ì ‘ì†',
    description: '3ì¼ ì—°ì†ìœ¼ë¡œ ì ‘ì†í–ˆì–´ìš”.',
    points: 20,
    icon: 'ğŸ”¥',
    category: 'Streak',
    metric: 'login_streak',
    threshold: 3,
  }),
  makeRule({
    id: 'login_streak_7',
    name: '7ì¼ ì—°ì† ì ‘ì†',
    description: '7ì¼ ì—°ì†ìœ¼ë¡œ ì ‘ì†í–ˆì–´ìš”.',
    points: 40,
    icon: 'âš¡',
    category: 'Streak',
    metric: 'login_streak',
    threshold: 7,
  }),
];

/** ë©”íƒ€(ë·°ìš©)ë§Œ DBì— ë„£ìŠµë‹ˆë‹¤. check/metric/thresholdëŠ” ëŸ°íƒ€ì„ì—ì„œ ì‚¬ìš© */
const UPSERT_SQL = `
INSERT INTO achievements (id, key, name, description, points, icon, category, secret)
VALUES (@id, @key, @name, @description, @points, @icon, @category, @secret)
ON CONFLICT(id) DO UPDATE SET
  key=excluded.key,
  name=excluded.name,
  description=excluded.description,
  points=excluded.points,
  icon=excluded.icon,
  category=excluded.category,
  secret=excluded.secret
`;

/** ì¸ë±ìŠ¤ ìµœì í™”: ìµœì´ˆ í•œ ë²ˆë§Œ ìƒì„±(ìˆìœ¼ë©´ ë¬´ì‹œ) */
function ensureIndexes() {
  db.exec(`
    CREATE INDEX IF NOT EXISTS idx_achievements_key ON achievements(key);
    CREATE INDEX IF NOT EXISTS idx_achievements_category ON achievements(category);
  `);
}

/** Seed achievements (UPSERT + íŠ¸ëœì­ì…˜ + í”„ë¦¬í˜ì–´ë“œ) */
export function seedAchievements() {
  ensureIndexes();
  const stmt = db.prepare(UPSERT_SQL);
  const asRow = (r) => ({
    id: r.id,
    key: r.key ?? r.id,
    name: r.name,
    description: r.description,
    points: r.points,
    icon: r.icon,
    category: r.category,
    secret: r.secret ? 1 : 0,
  });
  const tx = db.transaction((rows) => {
    for (const r of rows) stmt.run(asRow(r));
  });
  tx(RULES);
}

/** ìœ í‹¸: í˜„ì¬ ìƒíƒœì—ì„œ ë‹¬ì„±/ì§„í–‰ë„ ê³„ì‚° */
export function evaluateAll(state) {
  const unlocked = [];
  const inProgress = [];
  for (const r of RULES) {
    const res = r.check(state);
    if (res === true) {
      unlocked.push({ id: r.id, points: r.points });
    } else {
      inProgress.push({ id: r.id, ...res, points: r.points });
    }
  }
  return { unlocked, inProgress };
}
